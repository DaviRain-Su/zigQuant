# Order Manager - è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†

> Order Manager æä¾›å®Œæ•´çš„è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è®¢å•æäº¤ã€çŠ¶æ€è·Ÿè¸ªã€å–æ¶ˆæ“ä½œå’Œå®æ—¶äº‹ä»¶å¤„ç†

**æœ€åæ›´æ–°**: 2025-12-24
**çŠ¶æ€**: âœ… å®Œæˆ
**æµ‹è¯•**: 156/156 é€šè¿‡

---

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [äº‹ä»¶å¤„ç†](#äº‹ä»¶å¤„ç†)
- [æµ‹è¯•](#æµ‹è¯•)

---

## æ¦‚è¿°

### åŠŸèƒ½ç‰¹æ€§

Order Manager æ˜¯ zigQuant äº¤æ˜“ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

#### ğŸ“¦ è®¢å•å­˜å‚¨å’Œç´¢å¼•

- **åŒç´¢å¼•æœºåˆ¶**ï¼š
  - `client_order_id`ï¼šå®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€ IDï¼ˆUUID æ ¼å¼ï¼‰
  - `exchange_order_id`ï¼šäº¤æ˜“æ‰€è¿”å›çš„è®¢å• ID
- **è®¢å•åˆ†ç±»**ï¼š
  - æ´»è·ƒè®¢å•ï¼ˆpending, open, partially_filledï¼‰
  - å†å²è®¢å•ï¼ˆfilled, cancelled, rejectedï¼‰
- **é«˜æ•ˆæŸ¥è¯¢**ï¼š
  - æŒ‰ ID æŸ¥è¯¢ï¼ˆO(1) å¤æ‚åº¦ï¼‰
  - æŒ‰äº¤æ˜“å¯¹è¿‡æ»¤
  - åˆ†é¡µæ”¯æŒ

#### ğŸ”„ è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†

- **è®¢å•æäº¤**ï¼š
  - è‡ªåŠ¨ç”Ÿæˆ client_order_id
  - å‚æ•°éªŒè¯ï¼ˆlimit è®¢å•å¿…é¡»æœ‰ä»·æ ¼ï¼‰
  - è®¢å•é¢„å­˜å‚¨ï¼ˆæäº¤å‰ï¼‰
  - äº¤æ˜“æ‰€å“åº”åŒæ­¥
- **è®¢å•å–æ¶ˆ**ï¼š
  - å•ä¸ªè®¢å•å–æ¶ˆ
  - æ‰¹é‡å–æ¶ˆï¼ˆæŒ‰äº¤æ˜“å¯¹æˆ–å…¨éƒ¨ï¼‰
  - çŠ¶æ€æ£€æŸ¥ï¼ˆåªèƒ½å–æ¶ˆæ´»è·ƒè®¢å•ï¼‰
- **çŠ¶æ€åˆ·æ–°**ï¼š
  - ä¸»åŠ¨æŸ¥è¯¢äº¤æ˜“æ‰€
  - æœ¬åœ°çŠ¶æ€æ›´æ–°
  - å›è°ƒé€šçŸ¥

#### ğŸ“¡ å®æ—¶äº‹ä»¶å¤„ç†

- **WebSocket äº‹ä»¶é›†æˆ**ï¼š
  - è®¢å•çŠ¶æ€æ›´æ–°ï¼ˆ`handleOrderUpdate`ï¼‰
  - æˆäº¤äº‹ä»¶ï¼ˆ`handleOrderFill`ï¼‰
- **å›è°ƒæœºåˆ¶**ï¼š
  - `on_order_update`ï¼šè®¢å•çŠ¶æ€å˜åŒ–
  - `on_order_fill`ï¼šè®¢å•å®Œå…¨æˆäº¤
- **è‡ªåŠ¨çŠ¶æ€åŒæ­¥**ï¼š
  - æˆäº¤é‡ç´¯è®¡
  - å¹³å‡æˆäº¤ä»·è®¡ç®—ï¼ˆåŠ æƒå¹³å‡ï¼‰
  - è®¢å•çŠ¶æ€è‡ªåŠ¨è½¬æ¢

#### ğŸ”’ çº¿ç¨‹å®‰å…¨

- **Mutex ä¿æŠ¤**ï¼šæ‰€æœ‰å…¬å¼€æ–¹æ³•ä½¿ç”¨ `std.Thread.Mutex`
- **åŸå­æ“ä½œ**ï¼šclient_order_id ç”Ÿæˆå™¨ä½¿ç”¨åŸå­è®¡æ•°å™¨
- **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒ

#### ğŸ”Œ äº¤æ˜“æ‰€æŠ½è±¡

- **åŸºäº IExchange æ¥å£**ï¼šä¸å…·ä½“äº¤æ˜“æ‰€è§£è€¦
- **ç»Ÿä¸€æ•°æ®ç±»å‹**ï¼šä½¿ç”¨ exchange/types.zig ä¸­çš„ç»Ÿä¸€ç±»å‹
- **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°äº¤æ˜“æ‰€åªéœ€å®ç° IExchange æ¥å£

---

## æ¶æ„è®¾è®¡

### ç»„ä»¶å…³ç³»å›¾

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       OrderManager                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Public API                                             â”‚â”‚
â”‚  â”‚ â€¢ submitOrder()       â€¢ cancelOrder()                  â”‚â”‚
â”‚  â”‚ â€¢ cancelAllOrders()   â€¢ getActiveOrders()              â”‚â”‚
â”‚  â”‚ â€¢ getOrderHistory()   â€¢ refreshOrderStatus()           â”‚â”‚
â”‚  â”‚ â€¢ handleOrderUpdate() â€¢ handleOrderFill()              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   OrderStore        â”‚    â”‚   IExchange (vtable)     â”‚   â”‚
â”‚  â”‚                     â”‚    â”‚                          â”‚   â”‚
â”‚  â”‚ â€¢ client_id index   â”‚    â”‚ â€¢ createOrder()          â”‚   â”‚
â”‚  â”‚ â€¢ exchange_id index â”‚    â”‚ â€¢ cancelOrder()          â”‚   â”‚
â”‚  â”‚ â€¢ active orders     â”‚    â”‚ â€¢ getOrder()             â”‚   â”‚
â”‚  â”‚ â€¢ history orders    â”‚    â”‚ â€¢ ...                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Callbacks           â”‚    â”‚  Exchange Connector  â”‚
    â”‚                       â”‚    â”‚                      â”‚
    â”‚ â€¢ on_order_update     â”‚    â”‚ â€¢ HyperliquidConn    â”‚
    â”‚ â€¢ on_order_fill       â”‚    â”‚ â€¢ BinanceConn (*)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## æ ¸å¿ƒç»„ä»¶

### 1. OrderStore

**æ–‡ä»¶**: `src/trading/order_store.zig`

è®¢å•å­˜å‚¨å’Œç´¢å¼•ç»„ä»¶ï¼Œè´Ÿè´£å†…å­˜ä¸­çš„è®¢å•ç®¡ç†ã€‚

**æ ¸å¿ƒæ–¹æ³•**:
- `add(order)`: æ·»åŠ æ–°è®¢å•ï¼ˆè‡ªåŠ¨å»ºç«‹åŒç´¢å¼•ï¼‰
- `update(client_order_id)`: æ›´æ–°è®¢å•ï¼ˆè‡ªåŠ¨ç»´æŠ¤ç´¢å¼•ï¼Œå¯èƒ½ç§»è‡³å†å²ï¼‰
- `getByClientId(id)`: æŒ‰å®¢æˆ·ç«¯ ID æŸ¥è¯¢
- `getByExchangeId(id)`: æŒ‰äº¤æ˜“æ‰€ ID æŸ¥è¯¢
- `getActive()`: è·å–æ‰€æœ‰æ´»è·ƒè®¢å•
- `getHistory(pair, limit)`: è·å–å†å²è®¢å•ï¼ˆå¯æŒ‰äº¤æ˜“å¯¹è¿‡æ»¤ï¼‰

### 2. OrderManager

**æ–‡ä»¶**: `src/trading/order_manager.zig`

è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼Œæä¾›ç»Ÿä¸€çš„è®¢å•æ“ä½œæ¥å£ã€‚

**æ ¸å¿ƒæ–¹æ³•**:
- **è®¢å•æ“ä½œ**: `submitOrder()`, `cancelOrder()`, `cancelAllOrders()`
- **æŸ¥è¯¢æ–¹æ³•**: `getActiveOrders()`, `getOrderHistory()`, `refreshOrderStatus()`, `getStats()`
- **äº‹ä»¶å¤„ç†**: `handleOrderUpdate()`, `handleOrderFill()`

---

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

**è¦†ç›–èŒƒå›´**:
\`\`\`
âœ… OrderStore: init and deinit
âœ… OrderStore: add and retrieve by client ID
âœ… OrderManager: init and deinit
âœ… OrderManager: handleOrderUpdate
âœ… OrderManager: handleOrderFill
\`\`\`

**è¿è¡Œæµ‹è¯•**:
\`\`\`bash
zig build test
\`\`\`

**ç»“æœ**:
\`\`\`
Build Summary: 8/8 steps succeeded; 156/156 tests passed
\`\`\`

---

## ä¸‹ä¸€æ­¥

- [ ] æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆè¿æ¥ testnetï¼‰
- [ ] å®ç° Position Trackerï¼ˆä»“ä½è·Ÿè¸ªï¼‰
- [ ] æ·»åŠ  CLI å‘½ä»¤ï¼ˆäº¤äº’å¼è®¢å•ç®¡ç†ï¼‰

---

## å‚è€ƒèµ„æ–™

- [IExchange Interface](../../core/exchange-router.md)
- [Hyperliquid Connector](../hyperliquid-connector/README.md)
- [Exchange Types](../../../src/exchange/types.zig)
- [Story 010 - Order Manager](../../../stories/v0.2-mvp/010-order-manager.md)
