# 订单簿 - Bug 追踪

> 已知问题和修复记录

**最后更新**: 2025-12-23

---

## 当前状态

当前无已知的 Critical 或 High 优先级 Bug。订单簿模块处于 v0.2.0 开发阶段，核心功能已实现，正在进行测试和优化。

---

## 已知 Bug

暂无已知 Bug。

---

## 已修复的 Bug

暂无历史修复记录（v0.2.0 初始版本）。

---

## 报告 Bug

如果发现订单簿相关的问题，请提供以下信息：

### 1. Bug 标题
简洁描述问题（例如：订单簿更新后排序错误）

### 2. 严重性
- **Critical**: 系统崩溃或数据丢失
- **High**: 核心功能无法使用
- **Medium**: 功能部分失效或性能问题
- **Low**: 边界情况或优化建议

### 3. 复现步骤
提供最小化的复现代码：

```zig
const std = @import("std");
const OrderBook = @import("core/orderbook.zig").OrderBook;

test "reproduce bug" {
    // 复现步骤
}
```

### 4. 预期/实际行为
- **预期行为**: 描述应该发生什么
- **实际行为**: 描述实际发生了什么

### 5. 环境信息
- Zig 版本: `zig version`
- 操作系统: Linux/macOS/Windows
- 订单簿版本: v0.2.0
- 相关配置或数据

---

## Bug 优先级定义

### Critical
- 系统崩溃（Panic/Segfault）
- 数据损坏或丢失
- 内存泄漏导致 OOM
- 安全漏洞

**处理时间**: 立即修复

### High
- 核心功能失效（无法更新订单簿）
- 计算结果错误（价格、深度、滑点）
- 性能严重劣化（>10x 预期）
- 线程安全问题

**处理时间**: 1-2 天

### Medium
- 边界情况处理不当
- 性能未达标（2-10x 预期）
- 错误处理不完善
- API 设计问题

**处理时间**: 1 周

### Low
- 代码优化建议
- 文档错误或遗漏
- 测试覆盖不足
- 非关键性能优化

**处理时间**: 下一个版本

---

## 潜在风险点

虽然尚未发现 Bug，但以下是已识别的潜在风险点：

### 1. 排序一致性
**描述**: 增量更新后可能导致订单簿排序不正确

**缓解措施**:
- 添加 `validate()` 函数检查排序
- 单元测试覆盖各种更新场景

### 2. 并发访问
**描述**: 多线程同时访问可能导致数据竞争

**缓解措施**:
- `OrderBookManager` 使用 `Mutex` 保护
- 建议使用 `OrderBookManager` 而非直接访问 `OrderBook`

### 3. 内存分配
**描述**: 频繁更新可能导致内存碎片

**缓解措施**:
- 使用 `clearRetainingCapacity()` 保留容量
- 支持 `initWithCapacity()` 预分配

### 4. Decimal 精度
**描述**: 价格计算可能存在精度问题

**缓解措施**:
- 使用 `Decimal` 类型而非浮点数
- 测试极大/极小价格边界

### 5. 序列号跳跃
**描述**: WebSocket 消息丢失可能导致订单簿不一致

**缓解措施**:
- 记录 `sequence` 字段
- 检测跳跃并重新同步快照（待实现）

---

## 测试覆盖

为降低 Bug 风险，已实现以下测试：

- ✅ 快照应用
- ✅ 增量更新
- ✅ 最优价格查询
- ✅ 深度和滑点计算
- ✅ 空订单簿处理
- ✅ 流动性不足处理
- ✅ 性能基准测试

待补充：
- [ ] 并发访问测试
- [ ] 大规模订单簿测试
- [ ] 模糊测试
- [ ] 内存泄漏检测

---

*如有任何问题，请参考 [测试文档](./testing.md) 或联系维护者。*
