# Hot Reload - ç­–ç•¥çƒ­é‡è½½

> è¿è¡Œæ—¶ç­–ç•¥å‚æ•°æ›´æ–°ï¼Œæ— éœ€é‡å¯äº¤æ˜“å¼•æ“

**çŠ¶æ€**: ğŸ“‹ å¾…å¼€å§‹
**ç‰ˆæœ¬**: v0.6.0
**Story**: [Story 032](../../stories/v0.6.0/STORY_032_HOT_RELOAD.md)
**æœ€åæ›´æ–°**: 2025-12-27

---

## æ¦‚è¿°

Hot Reload (çƒ­é‡è½½) æ˜¯ zigQuant v0.6.0 çš„å¢å¼ºåŠŸèƒ½ï¼Œæ”¯æŒåœ¨äº¤æ˜“å¼•æ“è¿è¡Œæ—¶åŠ¨æ€æ›´æ–°ç­–ç•¥å‚æ•°ï¼Œæ— éœ€åœæ­¢å’Œé‡å¯ç³»ç»Ÿã€‚è¿™å¤§å¤§æé«˜äº†ç­–ç•¥è°ƒä¼˜æ•ˆç‡å’Œç³»ç»Ÿå¯ç”¨æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **é…ç½®æ–‡ä»¶ç›‘æ§**: è‡ªåŠ¨æ£€æµ‹é…ç½®æ–‡ä»¶å˜åŒ–
- **å‚æ•°éªŒè¯**: åŠ è½½å‰éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
- **å®‰å…¨é‡è½½**: åœ¨å®‰å…¨æ—¶æœº (tick é—´éš™) æ‰§è¡Œæ›´æ–°
- **å¤‡ä»½æœºåˆ¶**: é‡è½½å‰è‡ªåŠ¨å¤‡ä»½å½“å‰é…ç½®
- **äº‹ä»¶é€šçŸ¥**: é€šè¿‡ MessageBus å‘å¸ƒé‡è½½äº‹ä»¶

---

## å¿«é€Ÿå¼€å§‹

### ä»£ç ä½¿ç”¨

```zig
const HotReloadManager = @import("zigQuant").HotReloadManager;

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    // åˆ›å»ºç­–ç•¥å’Œæ¶ˆæ¯æ€»çº¿
    var strategy = DualMAStrategy.init(.{ .fast = 10, .slow = 30 });
    var bus = MessageBus.init(allocator);

    // åˆ›å»ºçƒ­é‡è½½ç®¡ç†å™¨
    var manager = try HotReloadManager.init(
        allocator,
        "config/strategy.json",
        &strategy.asStrategy(),
        &bus,
        .{
            .watch_interval_ms = 1000,
            .validate_before_reload = true,
            .backup_on_reload = true,
        },
    );
    defer manager.deinit();

    // å¯åŠ¨ç›‘æ§
    try manager.start();

    // ç°åœ¨å¯ä»¥ç¼–è¾‘ config/strategy.jsonï¼Œæ›´æ”¹ä¼šè‡ªåŠ¨åº”ç”¨
}
```

### CLI ä½¿ç”¨

```bash
# å¯åŠ¨æ—¶å¯ç”¨çƒ­é‡è½½
zigquant run-strategy --strategy dual_ma --paper --hot-reload

# æŒ‡å®šé…ç½®æ–‡ä»¶
zigquant run-strategy --strategy dual_ma --paper --config strategy.json --hot-reload

# æ‰‹åŠ¨è§¦å‘é‡è½½ (é€šè¿‡ä¿¡å·)
kill -USR1 <pid>
```

---

## ç›¸å…³æ–‡æ¡£

- [API å‚è€ƒ](./api.md) - å®Œæ•´çš„ API æ–‡æ¡£
- [å®ç°ç»†èŠ‚](./implementation.md) - æ–‡ä»¶ç›‘æ§å’Œé‡è½½é€»è¾‘
- [æµ‹è¯•æ–‡æ¡£](./testing.md) - æµ‹è¯•ç”¨ä¾‹
- [Bug è¿½è¸ª](./bugs.md) - å·²çŸ¥é—®é¢˜
- [å˜æ›´æ—¥å¿—](./changelog.md) - ç‰ˆæœ¬å†å²

---

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HotReloadManager                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ConfigWatcher  â”‚    â”‚  ParamValidator â”‚                â”‚
â”‚  â”‚  (æ–‡ä»¶ç›‘æ§)     â”‚    â”‚  (å‚æ•°éªŒè¯)     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                      â”‚                          â”‚
â”‚           â†“                      â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  ReloadScheduler                      â”‚  â”‚
â”‚  â”‚            (å®‰å…¨æ—¶æœºè°ƒåº¦é‡è½½)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                 â”‚
â”‚           â†“                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚    Strategy     â”‚    â”‚   MessageBus    â”‚                â”‚
â”‚  â”‚  (å‚æ•°æ›´æ–°)     â”‚    â”‚  (é€šçŸ¥äº‹ä»¶)     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®æ–‡ä»¶æ ¼å¼

```json
{
  "strategy": "dual_ma",
  "version": 2,
  "params": {
    "fast_period": {
      "value": 10,
      "min": 2,
      "max": 50,
      "description": "Fast MA period"
    },
    "slow_period": {
      "value": 30,
      "min": 10,
      "max": 200,
      "description": "Slow MA period"
    },
    "position_size": {
      "value": 0.1,
      "min": 0.01,
      "max": 1.0,
      "description": "Position size as fraction of balance"
    }
  },
  "risk": {
    "stop_loss_pct": 0.02,
    "take_profit_pct": 0.05,
    "max_position_size": 1000
  }
}
```

---

## é…ç½®é€‰é¡¹

```zig
pub const Config = struct {
    /// ç›‘æ§é—´éš” (æ¯«ç§’)
    watch_interval_ms: u32 = 1000,

    /// é‡è½½å‰éªŒè¯å‚æ•°
    validate_before_reload: bool = true,

    /// åªåœ¨ tick é—´éš™é‡è½½
    reload_on_tick: bool = true,

    /// é‡è½½å‰å¤‡ä»½é…ç½®
    backup_on_reload: bool = true,
};
```

---

## å·¥ä½œæµç¨‹

1. **æ£€æµ‹å˜åŒ–**: ConfigWatcher å®šæœŸæ£€æŸ¥é…ç½®æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
2. **è¯»å–é…ç½®**: å‘ç°å˜åŒ–åè¯»å–æ–°é…ç½®
3. **éªŒè¯å‚æ•°**: ParamValidator éªŒè¯å‚æ•°èŒƒå›´å’Œé€»è¾‘çº¦æŸ
4. **å¤‡ä»½å½“å‰**: ä¿å­˜å½“å‰é…ç½®ä½œä¸ºå¤‡ä»½
5. **è°ƒåº¦é‡è½½**: ReloadScheduler ç­‰å¾…å®‰å…¨æ—¶æœº
6. **åº”ç”¨æ›´æ–°**: è°ƒç”¨ç­–ç•¥çš„ updateParams æ–¹æ³•
7. **å‘å¸ƒäº‹ä»¶**: é€šè¿‡ MessageBus é€šçŸ¥å…¶ä»–ç»„ä»¶

---

## æœ€ä½³å®è·µ

### DO

```zig
// ä½¿ç”¨åˆç†çš„ç›‘æ§é—´éš”
.watch_interval_ms = 1000,  // 1 ç§’

// å§‹ç»ˆå¯ç”¨éªŒè¯
.validate_before_reload = true,

// ä¿ç•™å¤‡ä»½ä»¥ä¾¿å›æ»š
.backup_on_reload = true,
```

### DON'T

```zig
// é¿å…è¿‡äºé¢‘ç¹çš„ç›‘æ§
.watch_interval_ms = 10,  // 10ms å¤ªé¢‘ç¹

// é¿å…è·³è¿‡éªŒè¯
.validate_before_reload = false,  // å±é™©

// é¿å…åœ¨ tick ä¸­é—´é‡è½½
.reload_on_tick = false,  // å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| é‡è½½å»¶è¿Ÿ | < 100ms | æ£€æµ‹åˆ°å˜åŒ–åˆ°åº”ç”¨ |
| éªŒè¯å®Œæ•´æ€§ | 100% | æ— æ•ˆå‚æ•°è¢«æ‹’ç» |
| å®‰å…¨æ€§ | 100% | ä¸åœ¨ tick ä¸­é—´é‡è½½ |
| å›æ»šèƒ½åŠ› | æ”¯æŒ | ä¿ç•™å¤‡ä»½ |

---

## IStrategy æ¥å£æ‰©å±•

ä¸ºæ”¯æŒçƒ­é‡è½½ï¼Œç­–ç•¥éœ€è¦å®ç°é¢å¤–çš„æ–¹æ³•ï¼š

```zig
pub const IStrategy = struct {
    pub const VTable = struct {
        // ç°æœ‰æ–¹æ³•
        onData: *const fn (*anyopaque, MarketData) Signal,

        // çƒ­é‡è½½æ”¯æŒ
        updateParams: *const fn (*anyopaque, []const Param) anyerror!void,
        validateParams: *const fn (*anyopaque, []const Param) anyerror!void,
        getParams: *const fn (*anyopaque) []const Param,
    };
};
```

---

*Last updated: 2025-12-27*
