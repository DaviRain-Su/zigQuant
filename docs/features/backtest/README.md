# Backtest Engine - å›æµ‹å¼•æ“

**ç‰ˆæœ¬**: v0.3.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**å±‚çº§**: Strategy Layer
**ä¾èµ–**: Strategy Framework, Indicators Library, Market (Candles), Core (Decimal, Time)

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
   - [CLI å‘½ä»¤è¡Œä½¿ç”¨](#cli-å‘½ä»¤è¡Œä½¿ç”¨)
   - [ç­–ç•¥é…ç½®æ–‡ä»¶æ ¼å¼](#ç­–ç•¥é…ç½®æ–‡ä»¶æ ¼å¼)
   - [å›æµ‹ç»“æœç¤ºä¾‹](#å›æµ‹ç»“æœç¤ºä¾‹)
   - [ç¨‹åºåŒ– API ä½¿ç”¨](#ç¨‹åºåŒ–-api-ä½¿ç”¨)
4. [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
5. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
6. [v0.3.0 å®Œæˆæƒ…å†µ](#v030-å®Œæˆæƒ…å†µ)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

Backtest Engine æ˜¯ zigQuant çš„å›æµ‹å¼•æ“ï¼Œä½¿ç”¨å†å²æ•°æ®éªŒè¯ç­–ç•¥æ•ˆæœã€‚

### è®¾è®¡ç›®æ ‡

- **å‡†ç¡®æ€§**: çœŸå®æ¨¡æ‹Ÿå¸‚åœºæ¡ä»¶
- **é«˜æ€§èƒ½**: å¿«é€Ÿå›æµ‹å¤§é‡å†å²æ•°æ®
- **æ˜“ç”¨æ€§**: ç®€å•çš„ API è®¾è®¡
- **å®Œæ•´æ€§**: è¯¦ç»†çš„æ€§èƒ½åˆ†ææŠ¥å‘Š

### å…³é”®æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backtest Engine                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Historical Data  â”‚ (Kçº¿æ•°æ®)              â”‚
â”‚  â”‚     Feed         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                                  â”‚
â”‚           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚     Strategy     â”‚ (ç­–ç•¥æ‰§è¡Œ)             â”‚
â”‚  â”‚    Executor      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                                  â”‚
â”‚           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚      Event       â”‚ (äº‹ä»¶æ¨¡æ‹Ÿ)             â”‚
â”‚  â”‚    Simulator     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                                  â”‚
â”‚           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   Performance    â”‚ (ç»“æœåˆ†æ)             â”‚
â”‚  â”‚    Analyzer      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. Historical Data Feed

åŠ è½½å’Œç®¡ç†å†å²Kçº¿æ•°æ®ï¼š

- CSV æ–‡ä»¶å¯¼å…¥
- æ•°æ®åº“æŸ¥è¯¢
- API è·å–ï¼ˆHyperliquidç­‰ï¼‰
- è‡ªå®šä¹‰æ•°æ®æº

### 2. Event Simulator

æ¨¡æ‹Ÿå¸‚åœºäº‹ä»¶ï¼š

- æ–°èœ¡çƒ›äº‹ä»¶
- è®¢å•æˆäº¤äº‹ä»¶
- æ»‘ç‚¹æ¨¡æ‹Ÿ
- æ‰‹ç»­è´¹è®¡ç®—

### 3. Performance Analyzer

æ€§èƒ½åˆ†æå’ŒæŠ¥å‘Šï¼š

- æ€»æ”¶ç›Š/äºæŸ
- èƒœç‡
- ç›ˆäºæ¯”
- å¤æ™®æ¯”ç‡
- æœ€å¤§å›æ’¤
- å¹³å‡æŒä»“æ—¶é—´

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### CLI å‘½ä»¤è¡Œä½¿ç”¨

#### 1. åŸºæœ¬å›æµ‹å‘½ä»¤

ä½¿ç”¨å†…ç½®ç­–ç•¥è¿›è¡Œå›æµ‹ï¼š

```bash
# ä½¿ç”¨åŒå‡çº¿ç­–ç•¥å›æµ‹
zigquant backtest --strategy dual_ma --config examples/strategies/dual_ma.json

# ä½¿ç”¨ RSI å‡å€¼å›å½’ç­–ç•¥
zigquant backtest --strategy rsi_mean_reversion --config examples/strategies/rsi_mean_reversion.json

# ä½¿ç”¨å¸ƒæ—å¸¦çªç ´ç­–ç•¥
zigquant backtest --strategy bollinger_breakout --config examples/strategies/bollinger_breakout.json
```

#### 2. æŒ‡å®šå†å²æ•°æ®

```bash
# ä½¿ç”¨è‡ªå®šä¹‰ CSV æ•°æ®æ–‡ä»¶
zigquant backtest \
  --strategy dual_ma \
  --config examples/strategies/dual_ma.json \
  --data data/BTCUSDT_1h_2024.csv
```

#### 3. è¦†ç›–é…ç½®å‚æ•°

```bash
# è¦†ç›–æ—¶é—´èŒƒå›´å’Œåˆå§‹èµ„é‡‘
zigquant backtest \
  --strategy dual_ma \
  --config examples/strategies/dual_ma.json \
  --start "2024-01-01T00:00:00Z" \
  --end "2024-06-30T23:59:59Z" \
  --capital 50000
```

#### 4. ä¿å­˜å›æµ‹ç»“æœ

```bash
# ä¿å­˜ç»“æœåˆ° JSON æ–‡ä»¶
zigquant backtest \
  --strategy dual_ma \
  --config examples/strategies/dual_ma.json \
  --output results/dual_ma_backtest.json
```

#### 5. æŸ¥çœ‹å¸®åŠ©

```bash
# æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨é€‰é¡¹
zigquant backtest --help
```

### ç­–ç•¥é…ç½®æ–‡ä»¶æ ¼å¼

åˆ›å»ºç­–ç•¥é…ç½® JSON æ–‡ä»¶ï¼ˆä¾‹å¦‚ `dual_ma.json`ï¼‰ï¼š

```json
{
  "strategy": "dual_ma",
  "pair": {
    "base": "BTC",
    "quote": "USDT"
  },
  "timeframe": "h1",
  "parameters": {
    "fast_period": 10,
    "slow_period": 20,
    "ma_type": "sma"
  }
}
```

### å›æµ‹ç»“æœç¤ºä¾‹

è¿è¡Œå›æµ‹åï¼Œä¼šæ˜¾ç¤ºè¯¦ç»†çš„æ€§èƒ½åˆ†æï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ å›æµ‹ç»“æœ                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç­–ç•¥: Dual Moving Average Strategy
äº¤æ˜“å¯¹: BTC-USDT
æ—¶é—´èŒƒå›´: 2024-01-01 è‡³ 2024-12-31 (365 å¤©)
åˆå§‹èµ„é‡‘: $10,000.00

äº¤æ˜“è¡¨ç°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»äº¤æ˜“æ•°:        42
  ç›ˆåˆ©äº¤æ˜“:        28 (66.67%)
  äºæŸäº¤æ˜“:        14 (33.33%)
  èƒœç‡:            66.67%

  æ€»ç›ˆåˆ©:          $2,800.00
  æ€»äºæŸ:          -$1,200.00
  å‡€åˆ©æ¶¦:          $1,600.00
  ç›ˆäºæ¯”:          2.33
  ç›ˆåˆ©å› å­:        2.88

é£é™©æŒ‡æ ‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æœ€å¤§å›æ’¤:        -12.5%
  å¤æ™®æ¯”ç‡:        1.45
  å¹³å‡æŒä»“æ—¶é—´:    48.5 å°æ—¶

èµ„é‡‘æ›²çº¿
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æœ€ç»ˆæƒç›Š:        $11,600.00
  æ€»å›æŠ¥:          +16.00%
```

### ç¨‹åºåŒ– API ä½¿ç”¨

å¦‚æœéœ€è¦åœ¨ä»£ç ä¸­ä½¿ç”¨å›æµ‹å¼•æ“ï¼š

```zig
const std = @import("std");
const zigQuant = @import("zigQuant");

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    // 1. åˆ›å»ºç­–ç•¥
    const strategy = try DualMAStrategy.create(allocator, 10, 20);
    defer strategy.deinit();

    // 2. é…ç½®å›æµ‹
    const config = BacktestConfig{
        .pair = .{ .base = "ETH", .quote = "USDC" },
        .timeframe = .m15,
        .start_time = try Timestamp.fromISO8601("2024-01-01T00:00:00Z"),
        .end_time = try Timestamp.fromISO8601("2024-12-31T23:59:59Z"),
        .initial_capital = try Decimal.fromInt(10000),
        .commission_rate = try Decimal.fromFloat(0.001),
    };

    // 3. åˆ›å»ºå›æµ‹å¼•æ“
    var engine = BacktestEngine.init(allocator, logger);
    defer engine.deinit();

    // 4. è¿è¡Œå›æµ‹
    const result = try engine.run(strategy, config);

    // 5. æŸ¥çœ‹ç»“æœ
    std.debug.print("æ€»äº¤æ˜“æ¬¡æ•°: {}\n", .{result.total_trades});
    std.debug.print("èƒœç‡: {d:.2}%\n", .{result.win_rate * 100});
    std.debug.print("å‡€åˆ©æ¶¦: {}\n", .{result.net_profit});
    std.debug.print("å¤æ™®æ¯”ç‡: {d:.2}\n", .{result.sharpe_ratio});
    std.debug.print("æœ€å¤§å›æ’¤: {d:.2}%\n", .{result.max_drawdown * 100});
}
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### BacktestResult

```zig
pub const BacktestResult = struct {
    // äº¤æ˜“ç»Ÿè®¡
    total_trades: u32,
    winning_trades: u32,
    losing_trades: u32,
    
    // ç›ˆäºç»Ÿè®¡
    total_profit: Decimal,
    total_loss: Decimal,
    net_profit: Decimal,
    
    // æ€§èƒ½æŒ‡æ ‡
    win_rate: f64,              // èƒœç‡
    profit_factor: f64,         // ç›ˆäºæ¯”
    sharpe_ratio: f64,          // å¤æ™®æ¯”ç‡
    max_drawdown: f64,          // æœ€å¤§å›æ’¤
    avg_trade_duration_minutes: f64,
    
    // è¯¦ç»†äº¤æ˜“è®°å½•
    trades: []Trade,
    equity_curve: []EquityPoint,
};
```

---

## âš¡ æ€§èƒ½æŒ‡æ ‡

- **å›æµ‹é€Ÿåº¦**: > 1000 candles/s
- **å†…å­˜å ç”¨**: < 200MB (10000 èœ¡çƒ› + ç­–ç•¥)
- **å‡†ç¡®æ€§**: ä¸å®ç›˜è¯¯å·® < 2%

---

## âœ… v0.3.0 å®Œæˆæƒ…å†µ

### å·²å®ç°åŠŸèƒ½

- âœ… BacktestEngine - æ ¸å¿ƒå›æµ‹å¼•æ“
- âœ… BacktestResult - å›æµ‹ç»“æœç±»å‹
- âœ… PerformanceAnalyzer - æ€§èƒ½åˆ†æå™¨
- âœ… PerformanceMetrics - æ€§èƒ½æŒ‡æ ‡
- âœ… Trade & Position è·Ÿè¸ª
- âœ… Account ç®¡ç†
- âœ… CSV æ•°æ®åŠ è½½ (HistoricalDataFeed)
- âœ… æ‰‹ç»­è´¹å’Œæ»‘ç‚¹æ¨¡æ‹Ÿ
- âœ… æƒç›Šæ›²çº¿ç”Ÿæˆ

### æ ¸å¿ƒç»„ä»¶

**æ–‡ä»¶ç»“æ„**:
```
src/backtest/
â”œâ”€â”€ engine.zig          # å›æµ‹å¼•æ“æ ¸å¿ƒ
â”œâ”€â”€ types.zig           # BacktestResult, BacktestConfig
â”œâ”€â”€ analyzer.zig        # æ€§èƒ½åˆ†æå™¨
â”œâ”€â”€ account.zig         # è´¦æˆ·ç®¡ç†
â”œâ”€â”€ position.zig        # æŒä»“è·Ÿè¸ª
â”œâ”€â”€ trade.zig           # äº¤æ˜“è®°å½•
â””â”€â”€ data_feed.zig       # å†å²æ•°æ®åŠ è½½
```

### ç¤ºä¾‹å’Œæµ‹è¯•

**ç¤ºä¾‹ä»£ç **:
- `examples/05_strategy_backtest.zig` - å®Œæ•´å›æµ‹ç¤ºä¾‹ âœ…

**æµ‹è¯•ä»£ç **:
- `tests/integration/strategy_full_test.zig` - é›†æˆæµ‹è¯• âœ…
  - æµ‹è¯• BacktestEngine ä¸æ‰€æœ‰ç­–ç•¥
  - æµ‹è¯• PerformanceAnalyzer
  - å†…å­˜æ³„æ¼æ£€æµ‹

### ä½¿ç”¨æ–¹æ³•

```bash
# è¿è¡Œå›æµ‹ç¤ºä¾‹
zig build run-example-backtest

# è¿è¡Œé›†æˆæµ‹è¯•
zig build test-strategy-full
```

---

**ç‰ˆæœ¬**: v0.3.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2025-12-26)
**æ›´æ–°æ—¶é—´**: 2025-12-26
